<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Scientific Glass Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .btn-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-glass:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }
        .btn-operator {
            background: rgba(255, 165, 0, 0.2);
            color: #ffcc00;
        }
        .btn-special {
            background: rgba(255, 255, 255, 0.2);
        }
        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="h-[100dvh] w-full flex items-center justify-center p-4">
    <div class="glass-panel h-full w-full max-w-md rounded-[40px] flex flex-col overflow-hidden relative">
        
        <!-- Header & History Toggle -->
        <div class="p-6 flex justify-between items-center">
            <span class="text-white/50 text-xs font-bold uppercase tracking-widest">Scientific</span>
            <button onclick="window.toggleHistory()" class="p-2 rounded-full hover:bg-white/10 text-white transition">
                <i data-lucide="history" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Display Area -->
        <div class="px-6 flex-1 flex flex-col justify-end text-right overflow-hidden mb-4">
            <div id="prev-calc" class="text-white/40 text-sm font-light min-h-[1.5rem] mb-1 truncate"></div>
            <div id="display" class="text-white text-5xl font-light truncate select-all">0</div>
        </div>

        <!-- Controls / Buttons -->
        <div class="p-4 grid grid-cols-4 gap-2 pb-[env(safe-area-inset-bottom)]">
            <!-- Scientific Row 1 -->
            <button onclick="window.appendFunc('sin(')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">sin</button>
            <button onclick="window.appendFunc('cos(')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">cos</button>
            <button onclick="window.appendFunc('tan(')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">tan</button>
            <button onclick="window.clearDisplay()" class="btn-glass text-orange-400 font-bold py-3 rounded-2xl text-sm">AC</button>

            <!-- Scientific Row 2 -->
            <button onclick="window.appendFunc('log(')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">log</button>
            <button onclick="window.appendFunc('sqrt(')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">√</button>
            <button onclick="window.appendChar('^')" class="btn-glass btn-special py-3 rounded-2xl text-white text-sm">xⁿ</button>
            <button onclick="window.deleteLast()" class="btn-glass text-orange-400 py-3 rounded-2xl flex items-center justify-center">
                <i data-lucide="delete" class="w-5 h-5"></i>
            </button>

            <!-- Numbers and Operators -->
            <button onclick="window.appendChar('7')" class="btn-glass py-5 rounded-3xl text-white text-xl">7</button>
            <button onclick="window.appendChar('8')" class="btn-glass py-5 rounded-3xl text-white text-xl">8</button>
            <button onclick="window.appendChar('9')" class="btn-glass py-5 rounded-3xl text-white text-xl">9</button>
            <button onclick="window.appendChar('/')" class="btn-glass btn-operator py-5 rounded-3xl text-2xl">÷</button>

            <button onclick="window.appendChar('4')" class="btn-glass py-5 rounded-3xl text-white text-xl">4</button>
            <button onclick="window.appendChar('5')" class="btn-glass py-5 rounded-3xl text-white text-xl">5</button>
            <button onclick="window.appendChar('6')" class="btn-glass py-5 rounded-3xl text-white text-xl">6</button>
            <button onclick="window.appendChar('*')" class="btn-glass btn-operator py-5 rounded-3xl text-2xl">×</button>

            <button onclick="window.appendChar('1')" class="btn-glass py-5 rounded-3xl text-white text-xl">1</button>
            <button onclick="window.appendChar('2')" class="btn-glass py-5 rounded-3xl text-white text-xl">2</button>
            <button onclick="window.appendChar('3')" class="btn-glass py-5 rounded-3xl text-white text-xl">3</button>
            <button onclick="window.appendChar('-')" class="btn-glass btn-operator py-5 rounded-3xl text-2xl">−</button>

            <button onclick="window.appendChar('0')" class="btn-glass py-5 rounded-3xl text-white text-xl">0</button>
            <button onclick="window.appendChar('.')" class="btn-glass py-5 rounded-3xl text-white text-xl">.</button>
            <button onclick="window.appendChar('Math.PI')" class="btn-glass py-5 rounded-3xl text-white text-xl">π</button>
            <button onclick="window.appendChar('+')" class="btn-glass btn-operator py-5 rounded-3xl text-2xl">+</button>

            <button onclick="window.calculate()" class="col-span-4 bg-orange-500 hover:bg-orange-600 text-white font-bold py-5 rounded-3xl text-2xl shadow-lg transition">=</button>
        </div>

        <!-- History Drawer -->
        <div id="history-drawer" class="absolute inset-0 glass-panel z-10 translate-y-full transition-transform duration-300 ease-in-out p-6 flex flex-col">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-white text-xl font-bold">History</h2>
                <button onclick="window.toggleHistory()" class="text-white/50">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="history-list" class="flex-1 overflow-y-auto hide-scroll space-y-4">
                <p class="text-white/30 text-center italic">No history yet</p>
            </div>
            <button onclick="window.clearHistory()" class="mt-4 text-orange-400 font-medium py-2">Clear History</button>
        </div>
    </div>

    <script>
        let currentInput = "";
        let history = [];

        // Initialization
        window.onload = () => {
            lucide.createIcons();
            const storedHistory = localStorage.getItem('calc_history');
            if (storedHistory) {
                history = JSON.parse(storedHistory);
                renderHistory();
            }
        };

        window.vibrate = () => {
            if (window.NativeBridge && window.NativeBridge.vibrate) {
                window.NativeBridge.vibrate(50);
            }
        };

        window.appendChar = (char) => {
            window.vibrate();
            if (currentInput === "0" && char !== '.') currentInput = "";
            currentInput += char;
            updateDisplay();
        };

        window.appendFunc = (func) => {
            window.vibrate();
            currentInput += func;
            updateDisplay();
        };

        window.clearDisplay = () => {
            window.vibrate();
            currentInput = "0";
            document.getElementById('prev-calc').innerText = "";
            updateDisplay();
        };

        window.deleteLast = () => {
            window.vibrate();
            currentInput = currentInput.slice(0, -1);
            if (currentInput === "") currentInput = "0";
            updateDisplay();
        };

        window.updateDisplay = () => {
            const display = document.getElementById('display');
            let readable = currentInput
                .replace(/Math.PI/g, "π")
                .replace(/\^/g, "^")
                .replace(/\//g, "÷")
                .replace(/\*/g, "×");
            display.innerText = readable || "0";
        };

        window.calculate = () => {
            window.vibrate();
            try {
                let expression = currentInput
                    .replace(/sin\(/g, "Math.sin(")
                    .replace(/cos\(/g, "Math.cos(")
                    .replace(/tan\(/g, "Math.tan(")
                    .replace(/log\(/g, "Math.log10(")
                    .replace(/sqrt\(/g, "Math.sqrt(")
                    .replace(/\^/g, "**");

                // Auto-close parentheses
                const openParenCount = (expression.match(/\(/g) || []).length;
                const closeParenCount = (expression.match(/\)/g) || []).length;
                for (let i = 0; i < openParenCount - closeParenCount; i++) {
                    expression += ")";
                }

                const result = eval(expression);
                const formattedResult = Number.isInteger(result) ? result : result.toFixed(8).replace(/\.0+$|(\.[0-9]*[1-9])0+$/, "$1");
                
                document.getElementById('prev-calc').innerText = currentInput + " =";
                
                // Save to history
                const entry = { exp: currentInput, res: formattedResult };
                history.unshift(entry);
                if (history.length > 20) history.pop();
                localStorage.setItem('calc_history', JSON.stringify(history));
                renderHistory();

                currentInput = formattedResult.toString();
                updateDisplay();
            } catch (e) {
                document.getElementById('display').innerText = "Error";
                setTimeout(() => {
                    currentInput = "0";
                    updateDisplay();
                }, 1500);
            }
        };

        window.toggleHistory = () => {
            window.vibrate();
            const drawer = document.getElementById('history-drawer');
            drawer.classList.toggle('translate-y-full');
            drawer.classList.toggle('translate-y-0');
        };

        window.renderHistory = () => {
            const list = document.getElementById('history-list');
            if (history.length === 0) {
                list.innerHTML = `<p class="text-white/30 text-center italic">No history yet</p>`;
                return;
            }
            list.innerHTML = history.map((item, idx) => `
                <div class="bg-white/5 p-4 rounded-2xl border border-white/10 active:scale-[0.98] transition cursor-pointer" onclick="window.useHistoryItem('${item.res}')">
                    <div class="text-white/40 text-xs mb-1 truncate">${item.exp}</div>
                    <div class="text-white text-lg font-semibold">= ${item.res}</div>
                </div>
            `).join('');
        };

        window.useHistoryItem = (val) => {
            window.vibrate();
            currentInput = val;
            updateDisplay();
            window.toggleHistory();
        };

        window.clearHistory = () => {
            window.vibrate();
            history = [];
            localStorage.removeItem('calc_history');
            renderHistory();
        };
    </script>
</body>
</html>